machine:
  services:
    - docker

general:
  branches:
    only:
      - master # list of branches to build
      - release/0.1.0
      - release/0.1.4

dependencies:
  override:
    - docker build -t mikeywaites/flask-servatus .
    - docker build -f Dockerfile.py3 -t mikeywaites/flask-servatus:py3 .

test:
  override:
    - docker run -it -v $(pwd):/opt/code mikeywaites/flask-servatus python setup.py test
    - docker run -it -v $(pwd):/opt/code mikeywaites/flask-servatus python setup.py install
    - docker run -it -v $(pwd):/opt/code mikeywaites/flask-servatus:py3 python setup.py test
    - docker run -it -v $(pwd):/opt/code mikeywaites/flask-servatus:py3 python setup.py install

deployment:
  pypi:
    branch: [master, release/0.1.0]
    commands:
      - sudo chown -R ubuntu:ubuntu flask_servatus.egg-info
      - sudo chown -R ubuntu:ubuntu dist
      - sed "s/PYPI_USERNAME/$PYPI_USERNAME/;s/PYPI_PASSWORD/$PYPI_PASSWORD/" < pypirc.template > ~/.pypirc
      - python setup.py sdist upload -r pypi
      - curl -X POST http://readthedocs.org/build/flask-servatus
